@page "/TaskDetail"
@page "/TaskDetail/{taskId}"
@page "/TaskDetail/{taskId}/{stepIndex:int}" // 添加新的路由，支持stepIndex参数
@inject ProcessOneService ProcessOneService
@inject ProcessTwoService ProcessTwoService
@inject ProcessThreeService ProcessThreeService
@inject TaskService TaskService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@if (isLoading)
{
    <div class="d-flex justify-content-center align-items-center min-vh-100">
        <MudSpinner Color="Color.Primary" Size="Size.Large"/>
        <MudText Class="ms-4" Typo="Typo.h6">加载任务数据中...</MudText>
    </div>
}
else if (task == null)
{
    <div class="d-flex justify-content-center align-items-center min-vh-100">
        <MudText Typo="Typo.h6" Color="Color.Error">无法加载任务数据，请检查任务ID是否正确</MudText>
    </div>
}
else
{
    <MudExpansionPanels Class="ma-2 mx-md-8">
        <MudExpansionPanel>
            <TitleContent>
                <div class="d-flex">
                    <MudText Typo="Typo.h6">任务明细 - @taskId</MudText>
                    <MudSpacer/>
                    <MudChip T="string"
                             Color="GetStatusColor(task.status)">@GetStatusText(task.status)</MudChip>
                </div>
            </TitleContent>
            <ChildContent>
                <div class="d-flex flex-column flex-md-row w-100">
                    <MudPaper Width="360px" Class="my-2 mx-1">
                        <MudList T="string">
                            <MudListItem Text="@($"任务标题：{task.title ?? ""}")"
                                         Icon="@Icons.Material.Filled.Subtitles"/>
                            <MudListItem Text="@($"任务描述：{task.description ?? ""}")"
                                         Icon="@Icons.Material.Filled.Dehaze"/>
                            <MudListItem
                                Text="@($"优先级：{(task.priority == 1 ? "低" : task.priority == 2 ? "中" : task.priority == 3 ? "高" : "")}")"
                                Icon="@Icons.Material.Filled.PriorityHigh"/>
                        </MudList>
                    </MudPaper>
                    <MudPaper Width="360px" Class="my-2 mx-1">
                        <MudList T="string">
                            <MudListItem Text="@($"负责人：{task.assignee_id ?? ""}")"
                                         Icon="@Icons.Material.Filled.ManageAccounts"/>
                            <MudListItem
                                Text="@($"创建日期：{task.created_at.ToString("yyyy-MM-dd HH:mm:ss") ?? ""}")"
                                Icon="@Icons.Material.Filled.CalendarMonth"/>
                            <MudListItem
                                Text="@($"更新日期：{task.updated_at.ToString("yyyy-MM-dd HH:mm:ss") ?? ""}")"
                                Icon="@Icons.Material.Filled.EditCalendar"/>
                        </MudList>
                    </MudPaper>
                </div>
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudPaper Class="ma-2 pa-md-4 mx-md-8" Elevation="3">
        <MudStepper NonLinear="true" @bind-ActiveIndex="currentStepIndex" NavClass="border-b mud-border-lines-default"
                    OnPreviewInteraction="OnPreviewInteraction"
                    StepClass="pt-4" ShowResetButton>
            <TitleTemplate>@**@</TitleTemplate>
            <ConnectorTemplate Context="step">
                <div class="mud-stepper-nav-connector">
                    @{
                        int value = step.Completed ? 100 : 0;
                        <MudProgressLinear Striped Value="value" Min="0" Max="100" Color="Color.Success"
                                           Style="height: 4px; background-color: #d4ddeb; border-radius: 2px;"/>
                    }
                </div>
            </ConnectorTemplate>
            <LabelTemplate>
                @if (context.IsActive)
                {
                    if (context.Completed)
                    {
                        <MudBadge Dot="true"  Color="Color.Error" Class="mx-2 my-1">
                            <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle"
                                     Color="Color.Success">@(context.Title)</MudChip>
                        </MudBadge>
                    }
                    else
                    {
                        <MudBadge Dot="true"  Color="Color.Error" Class="mx-2 my-1">
                            <MudChip T="string">@(context.Title)</MudChip>
                        </MudBadge>
                    }
                }
                else if (context.Completed)
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle"
                             Color="Color.Success">@(context.Title)</MudChip>
                }
                else
                {
                    <MudChip T="string">@(context.Title)</MudChip>
                }
            </LabelTemplate>
            <ChildContent>
                <!-- 1. 电机表格（带加载效果） -->
                <MudStep Completed="task.process_1" Title="1.电机粘蜗杆">
                    @if (isMotorTableLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">加载中...</MudText>
                        </div>
                    }
                    else if (finishedMotors.Count == 0)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                        </div>
                    }
                    else
                    {
                        <MudTable Items="finishedMotors" Hover="true" FixedHeader="true"
                                  SortLabel="Sort By" Elevation="3" Bordered="true" Striped="true"
                                  Dense="true">
                            <HeaderContent>
                                <MudTh>
                                    <MudTableSortLabel T="MotorDto"
                                                       SortBy="@(context => finishedMotors.IndexOf(context) + 1)">序号
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.motor_id">电机ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.task_id">任务ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.operator_id">操作员ID
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.created_at">创建时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.update_at">更新时间</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.is_qualified">是否合格
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.remarks">备注</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorDto x) => x.finger_id">手指ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>操作</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="序号">@(finishedMotors.IndexOf(context) + 1)</MudTd>
                                <MudTd DataLabel="电机ID">@context.motor_id</MudTd>
                                <MudTd DataLabel="任务ID">@context.task_id</MudTd>
                                <MudTd DataLabel="操作员ID">@context.operator_id</MudTd>
                                <MudTd DataLabel="创建时间">@context.created_at.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="更新时间">@context.update_at?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="是否合格">
                                    <MudChip T="string"
                                             Color="@(context.is_qualified ? Color.Success : Color.Error)">@(context.is_qualified ? "是" : "否")</MudChip>
                                </MudTd>
                                <MudTd DataLabel="备注">@context.remarks</MudTd>
                                <MudTd DataLabel="手指ID">@context.finger_id</MudTd>
                                <MudTd DataLabel="操作">
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info">修改
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error">删除
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager RowsPerPageString="显示数量"
                                               PageSizeOptions="new int[] { 10, 20, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    }
                </MudStep>

                <MudStep Completed="task.process_2" Title="2.蜗杆粘接检测">
                     @if (isMotorTableLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">加载中...</MudText>
                        </div>
                    }
                    else if (Detect1List.Count == 0)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                        </div>
                    }
                    else
                    {
                        <MudTable Items="Detect1List" Hover="true" FixedHeader="true"
                                  SortLabel="Sort By" Elevation="3" Bordered="true" Striped="true"
                                  Dense="true">
                            <HeaderContent>
                                <MudTh>
                                    <MudTableSortLabel T="MotorWormDetectDto"
                                                       SortBy="@(context => Detect1List.IndexOf(context) + 1)">序号
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.motor_id">电机编号</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.force">检测用力</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.distance_before">测试前的距离
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.distance_after">测试后的距离
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.distance_result">距离差
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.combine_time">粘合时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.using_time">使用时间</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.inspector_id">检测员</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.remarks">备注</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(MotorWormDetectDto x) => x.if_qualified">是否合格</MudTableSortLabel>
                                </MudTh>
                                <MudTh>操作</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="序号">@(Detect1List.IndexOf(context) + 1)</MudTd>
                                <MudTd DataLabel="电机ID">@context.motor_id</MudTd>
                                <MudTd DataLabel="任务ID">@context.force</MudTd>
                                <MudTd DataLabel="操作员ID">@context.distance_before</MudTd>
                                <MudTd DataLabel="操作员ID">@context.distance_after</MudTd>
                                <MudTd DataLabel="操作员ID">@context.distance_result</MudTd>
                                <MudTd DataLabel="创建时间">@context.combine_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="更新时间">@context.using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="操作员ID">@context.inspector_id</MudTd>
                                <MudTd DataLabel="操作员ID">@context.remarks</MudTd>
                                <MudTd DataLabel="是否合格">
                                    <MudChip T="string"
                                             Color="@(context.if_qualified ? Color.Success : Color.Error)">@(context.if_qualified ? "是" : "否")</MudChip>
                                </MudTd>
                                <MudTd DataLabel="操作">
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info">修改
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error">删除
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager RowsPerPageString="显示数量"
                                               PageSizeOptions="new int[] { 10, 20, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    }
                </MudStep>

                <MudStep Completed="task.process_3" Title="3.分指机构粘接检测">
                    @if (isMotorTableLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">加载中...</MudText>
                        </div>
                    }
                    else if (Detect2List.Count == 0)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                        </div>
                    }
                    else
                    {
                        <MudTable Items="Detect2List" Hover="true" FixedHeader="true"
                                  SortLabel="Sort By" Elevation="3" Bordered="true" Striped="true"
                                  Dense="true">
                            <HeaderContent>
                                <MudTh>
                                    <MudTableSortLabel T="SplitWormDetectDto"
                                                       SortBy="@(context => Detect2List.IndexOf(context) + 1)">序号
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.split_id">分指机构ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.combine_time">粘接时间</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.using_time">使用时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.inspector">检测员
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.remarks">备注</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(SplitWormDetectDto x) => x.if_qualified">是否合格
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>操作</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="序号">@(Detect2List.IndexOf(context) + 1)</MudTd>
                                <MudTd DataLabel="分指机构ID">@context.split_id</MudTd>
                                <MudTd DataLabel="粘合时间">@context.combine_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="使用时间">@context.using_time?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="检测人员">@context.inspector</MudTd>
                                <MudTd DataLabel="备注">@context.remarks</MudTd>
                                <MudTd DataLabel="是否合格">
                                    <MudChip T="string"
                                             Color="@(context.if_qualified ? Color.Success : Color.Error)">@(context.if_qualified ? "是" : "否")</MudChip>
                                </MudTd>
                                <MudTd DataLabel="操作">
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info">修改
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error">删除
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager RowsPerPageString="显示数量"
                                               PageSizeOptions="new int[] { 10, 20, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    }
                </MudStep>

                <MudStep Completed="task.process_4" Title="4.分指机构标定粘接">
                    <div class="d-flex justify-content-center align-items-center py-10">
                        <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                    </div>
                </MudStep>

                <!-- 5. 手指表格（带加载效果） -->
                <MudStep Completed="task.process_5" Title="5.手指组装">
                    @if (isFingerTableLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">加载中...</MudText>
                        </div>
                    }
                    else if (finishedFingers.Count == 0)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                        </div>
                    }
                    else
                    {
                        <MudTable Items="finishedFingers" Hover="true" FixedHeader="true"
                                  SortLabel="Sort By" Elevation="3" Bordered="true" Striped="true"
                                  Dense="true">
                            <HeaderContent>
                                <MudTh>
                                    <MudTableSortLabel T="FingerDto"
                                                       SortBy="@(context => finishedFingers.IndexOf(context) + 1)">序号
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.finger_id">手指外壳ID
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.task_id">任务ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.operator_id">操作员ID
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.created_at">创建时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.updated_at">更新时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.is_qualified">是否合格
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.remarks">备注</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(FingerDto x) => x.palm_id">手掌外壳ID
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>操作</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="序号">@(finishedFingers.IndexOf(context) + 1)</MudTd>
                                <MudTd DataLabel="手指外壳ID">@context.finger_id</MudTd>
                                <MudTd DataLabel="任务ID">@context.task_id</MudTd>
                                <MudTd DataLabel="操作员ID">@context.operator_id</MudTd>
                                <MudTd DataLabel="创建时间">@context.created_at.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="更新时间">@context.updated_at?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="是否合格">
                                    <MudChip T="string"
                                             Color="@(context.is_qualified ? Color.Success : Color.Error)">@(context.is_qualified ? "是" : "否")</MudChip>
                                </MudTd>
                                <MudTd DataLabel="备注">@context.remarks</MudTd>
                                <MudTd DataLabel="手掌外壳ID">@context.palm_id</MudTd>
                                <MudTd DataLabel="操作">
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info">修改
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error">删除
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager RowsPerPageString="显示数量"
                                               PageSizeOptions="new int[] { 10, 20, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    }
                </MudStep>

                <MudStep Completed="task.process_6" Title="6.单指标定检测">
                    <div class="d-flex justify-content-center align-items-center py-10">
                        <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                    </div>
                </MudStep>

                <!-- 7. 手掌表格（带加载效果） -->
                <MudStep Completed="task.process_7" Title="7.手掌组装">
                    @if (isPalmTableLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">加载中...</MudText>
                        </div>
                    }
                    else if (finishedPalms.Count == 0)
                    {
                        <div class="d-flex justify-content-center align-items-center py-10">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                        </div>
                    }
                    else
                    {
                        <MudTable Items="finishedPalms" Hover="true" FixedHeader="true"
                                  SortLabel="Sort By" Elevation="3" Bordered="true" Striped="true"
                                  Dense="true">
                            <HeaderContent>
                                <MudTh>
                                    <MudTableSortLabel T="PalmDto"
                                                       SortBy="@(context => finishedPalms.IndexOf(context) + 1)">序号
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.palm_id">手掌外壳ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.task_id">任务ID</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.operator_id">操作员ID
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.created_at">创建时间
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.updated_at">更新时间</MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.is_qualified">是否合格
                                    </MudTableSortLabel>
                                </MudTh>
                                <MudTh>
                                    <MudTableSortLabel SortBy="(PalmDto x) => x.remarks">备注</MudTableSortLabel>
                                </MudTh>
                                <MudTh>操作</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="序号">@(finishedPalms.IndexOf(context) + 1)</MudTd>
                                <MudTd DataLabel="手掌外壳ID">@context.palm_id</MudTd>
                                <MudTd DataLabel="任务ID">@context.task_id</MudTd>
                                <MudTd DataLabel="操作员ID">@context.operator_id</MudTd>
                                <MudTd DataLabel="创建时间">@context.created_at.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="更新时间">@context.updated_at?.ToString("yyyy-MM-dd HH:mm")</MudTd>
                                <MudTd DataLabel="是否合格">
                                    <MudChip T="string"
                                             Color="@(context.is_qualified ? Color.Success : Color.Error)">@(context.is_qualified ? "是" : "否")</MudChip>
                                </MudTd>
                                <MudTd DataLabel="备注">@context.remarks</MudTd>
                                <MudTd DataLabel="操作">
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info">修改
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error">删除
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                            <PagerContent>
                                <MudTablePager RowsPerPageString="显示数量"
                                               PageSizeOptions="new int[] { 10, 20, 50, 100 }"/>
                            </PagerContent>
                        </MudTable>
                    }
                </MudStep>

                <MudStep Completed="task.process_8" Title="8.整手标定检测">
                    <div class="d-flex justify-content-center align-items-center py-10">
                        <MudText Typo="Typo.body1" Color="Color.Secondary">暂无数据</MudText>
                    </div>
                </MudStep>
            </ChildContent>
            <ActionContent Context="stepper">
                @* <MudButton Variant="Variant.Filled" *@
                @*            Color="Color.Primary" *@
                @*            OnClick="@(() => GoToPrevious())" *@
                @*            Disabled="@(currentStepIndex <= 0)"> *@
                @*     <MudIcon Icon="@Icons.Material.Filled.ArrowBack"/> *@
                @*     上一步 *@
                @* </MudButton> *@
                @* <MudSpacer/> *@
                @* <MudButton Variant="Variant.Filled" *@
                @*            Color="Color.Primary" *@
                @*            OnClick="@(() => GoToNext())" *@
                @*            Disabled="@(currentStepIndex >= 7)"> *@
                @*     下一步 *@
                @*     <MudIcon Icon="@Icons.Material.Filled.ArrowForward"/> *@
                @* </MudButton> *@
            </ActionContent>
        </MudStepper>
    </MudPaper>
}

@code {
    [Parameter] public string taskId { get; set; }
    [Parameter] public int? stepIndex { get; set; } // 改为可空int，支持没有参数的情况
    
    private ProductTaskDto task;
    private bool _completed;
    private bool isLoading = true;
    private int currentStepIndex = 0;
    // 新增三个表格的加载状态变量
    private bool isMotorTableLoading = false;
    private bool isFingerTableLoading = false;
    private bool isPalmTableLoading = false;

    private List<MotorDto> finishedMotors = new List<MotorDto>();
    private List<FingerDto> finishedFingers = new List<FingerDto>();
    private List<PalmDto> finishedPalms = new List<PalmDto>();
    private List<MotorWormDetectDto> Detect1List = new List<MotorWormDetectDto>();
    private List<SplitWormDetectDto> Detect2List = new List<SplitWormDetectDto>();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(taskId))
        {
            if (stepIndex.HasValue && stepIndex.Value >= 0 && stepIndex.Value <= 7)
            {
                currentStepIndex = stepIndex.Value;
            }
            await LoadTaskDetail();
            await LoadStepData(currentStepIndex);
            // Console.WriteLine($"当前索引: {currentStepIndex}");
        }
        else
        {
            isLoading = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (stepIndex.HasValue && stepIndex.Value >= 0 && stepIndex.Value <= 7)
        {
            if (currentStepIndex != stepIndex.Value)
            {
                currentStepIndex = stepIndex.Value;
                await LoadStepData(currentStepIndex);
                StateHasChanged();
            }
        }
    }

    // 根据步骤索引加载对应的数据
    private async Task LoadStepData(int stepIndex)
    {
        switch (stepIndex)
        {
            case 0: // 步骤1
                await GetFinishedMotors();
                break;
            case 1: // 步骤2
                await GetMotorWormDetectList();
                break;
            case 2: // 步骤3
                await GetSplitWormDetectList();
                break;
            case 3: // 步骤4
                break;
            case 4: // 步骤5
                await GetFinishedFingers();
                break;
            case 5: // 步骤6
                break;
            case 6: // 步骤7
                await GetFinishedPalms();
                break;
            case 7: // 步骤8
                break;
            default:
                // 其他步骤不需要加载表格数据
                break;
        }
    }

    private async Task OnPreviewInteraction(StepperInteractionEventArgs arg)
    {
        if (arg.Action == StepAction.Activate)
        {
            int targetIndex = arg.StepIndex;
            currentStepIndex = targetIndex; 
            
            // 更新URL，但不触发页面重载
            var newUri = $"/TaskDetail/{taskId}/{targetIndex}";
            NavigationManager.NavigateTo(newUri, replace: true, forceLoad: false);
            
            await LoadStepData(targetIndex);
        }
    }

    // 电机表格数据加载
    private async Task GetFinishedMotors()
    {
        try
        {
            isMotorTableLoading = true;
            var result = await ProcessOneService.GetFinishedList(taskId);
            finishedMotors = result;
        }
        catch (Exception ex)
        {
            finishedMotors = new List<MotorDto>();
            Snackbar.Add($"加载电机数据失败: {ex.Message}", Severity.Warning);
        }
        finally
        {
            isMotorTableLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task GetMotorWormDetectList()
    {
        try
        {
            isMotorTableLoading = true;
            var result = await DetectService.GetMotorWormDetectList(taskId);
            Detect1List = result;
        }
        catch (Exception ex)
        {
            Detect1List = new List<MotorWormDetectDto>();
            Snackbar.Add($"加载检测数据失败: {ex.Message}", Severity.Warning);
        }
        finally
        {
            isMotorTableLoading = false;
            StateHasChanged();
        }
    }
    private async Task GetSplitWormDetectList()
    {
        try
        {
            isMotorTableLoading = true;
            var result = await DetectService.GetSplitWormDetectList(taskId);
            Detect2List = result;
        }
        catch (Exception ex)
        {
            Detect2List = new List<SplitWormDetectDto>();
            Snackbar.Add($"加载检测数据失败: {ex.Message}", Severity.Warning);
        }
        finally
        {
            isMotorTableLoading = false;
            StateHasChanged();
        }
    }
    // 手指表格数据加载
    private async Task GetFinishedFingers()
    {
        try
        {
            isFingerTableLoading = true;
            var result = await ProcessTwoService.GetFinishedList(taskId);
            finishedFingers = result;
        }
        catch (Exception ex)
        {
            finishedFingers = new List<FingerDto>();
            Snackbar.Add($"加载手指数据失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            isFingerTableLoading = false;
            StateHasChanged();
        }
    }

    // 手掌表格数据加载
    private async Task GetFinishedPalms()
    {
        try
        {
            isPalmTableLoading = true;
            var result = await ProcessThreeService.GetPalmList(taskId);
            finishedPalms = result;
        }
        catch (Exception ex)
        {
            finishedPalms = new List<PalmDto>();
            Snackbar.Add($"加载手掌数据失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            isPalmTableLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTaskDetail()
    {
        try
        {
            isLoading = true;
            task = await TaskService.GetTaskDetail(taskId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载任务失败: {ex.Message}");
            await DialogService.ShowMessageBox(
                "错误",
                $"加载任务失败: {ex.Message}",
                yesText: "确定");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStatusText(byte status) => status switch
    {
        0 => "待处理",
        1 => "进行中",
        2 => "已完成",
        3 => "已取消",
        _ => $"未知状态({status})"
    };

    private Color GetStatusColor(byte status) => status switch
    {
        0 => Color.Default,
        1 => Color.Info,
        2 => Color.Success,
        3 => Color.Error,
        _ => Color.Default
    };

    private void GoToNext()
    {
        if (currentStepIndex < 7) currentStepIndex++;
    }

    private void GoToPrevious()
    {
        if (currentStepIndex > 0) currentStepIndex--;
    }
}